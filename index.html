<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LogMate - Production & QC Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body{font-family:"Inter",sans-serif;background-color:#f3f4f6}.container{display:flex;min-height:100vh}#login-screen{display:flex;justify-content:center;align-items:center;min-height:100vh;background-color:#f3f4f6;width:100%}.login-card{width:100%;max-width:400px;padding:40px;background-color:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.08),0 0 0 1px rgba(0,0,0,.05);border-top:5px solid #06b6d4}.login-input{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:8px;margin-top:5px;transition:border-color .2s}.login-input:focus{outline:none;border-color:#06b6d4;box-shadow:0 0 0 3px rgba(6,182,212,.3)}.login-button{width:100%;padding:12px;background-color:#06b6d4;color:#fff;font-weight:600;border-radius:8px;transition:background-color .2s}.login-button:hover{background-color:#0891b2}.hidden-app{display:none!important}.sidebar{width:250px;background-color:#18202b;color:#fff;transition:width .3s ease-in-out, transform .3s ease-in-out;overflow-x:hidden;flex-shrink:0;padding-top:20px;box-shadow:4px 0 15px rgba(0,0,0,.4);position:sticky;top:0;left:0;display:flex;flex-direction:column;height:100vh}.sidebar.collapsed{width:60px}.logo-section{display:flex;align-items:center;flex-direction:column;padding:0 15px 25px;font-size:1.8em;font-weight:900;border-bottom:1px solid #374151;margin-bottom:10px;color:#d1d5db}.neterwala-logo-img{max-width:150px;height:auto;margin:0 auto 5px;display:block;filter:brightness(0) invert(1)}.sidebar.collapsed .neterwala-logo-img{max-width:40px}.sidebar.collapsed .logo-text{opacity:0;width:0;padding:0;margin:0}.menu-wrapper{flex-grow:1;overflow-y:auto;padding-bottom:10px}.menu-item,.parent-menu-item{display:flex;align-items:center;padding:12px 15px;cursor:pointer;transition:background-color .2s,color .2s;text-decoration:none;color:#d1d5db;white-space:nowrap}.parent-menu-item{font-weight:600;margin-top:5px}.menu-item:hover,.parent-menu-item:hover{background-color:#2c3e50}.menu-item.active,.parent-menu-item.active{background-color:#06b6d4;color:#fff;border-left:4px solid #06b6d4;padding-left:11px}.parent-menu-item.active{background-color:#06b6d4;border-left:4px solid #06b6d4}.submenu-container{max-height:0;overflow:hidden;transition:max-height .3s ease-in-out;background-color:#2c3e50}.submenu-container.open{max-height:500px}.submenu-item{padding-left:45px!important;font-size:.95em}.submenu-item.active{background-color:#0e7490!important;border-left:4px solid #06b6d4}.menu-icon{font-size:18px;margin-right:15px;min-width:20px;text-align:center}.sidebar.collapsed .menu-item-text{display:none}.sidebar.collapsed .menu-icon{margin-right:0}.sidebar.collapsed .parent-menu-item,.sidebar.collapsed .menu-item{justify-content:center}.sidebar.collapsed .parent-menu-item{padding-left:15px}.toggle-btn{position:fixed;top:15px;left:250px;background:#06b6d4;color:#fff;border:none;padding:8px 10px;cursor:pointer;z-index:20;transition:left .3s;border-radius:0 8px 8px 0;box-shadow:2px 2px 5px rgba(0,0,0,.2)}.sidebar.collapsed~.content-area .toggle-btn{left:60px}.sidebar-footer{padding:15px;text-align:center;border-top:1px solid #374151;font-size:.75rem;color:#9ca3af;white-space:nowrap}.sidebar.collapsed .sidebar-footer{display:none}.content-area{flex-grow:1;position:relative;padding-top:70px}.main-content{padding:20px}.sidebar{--sidebar-width:250px}.sidebar.collapsed{--sidebar-width:60px}.header-bar{left:var(--sidebar-width,250px);transition:left .3s;width:calc(100% - var(--sidebar-width))}.header-bar{position:fixed;top:0;right:0;height:70px;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.1);z-index:10;display:flex;justify-content:flex-end;align-items:center;padding:0 20px}.user-dropdown-toggle{display:flex;align-items:center;cursor:pointer;padding:5px 10px;border-radius:8px;transition:background-color .2s}.user-dropdown-toggle:hover{background-color:#f3f4f6}.user-avatar{width:40px;height:40px;background-color:#06b6d4;color:#fff;border-radius:50%;display:flex;justify-content:center;align-items:center;font-weight:600;margin-right:10px}.user-name{font-weight:600;color:#1f2937}.profile-dropdown{position:absolute;top:60px;right:20px;background:#fff;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.15);width:200px;overflow:hidden;z-index:30}.profile-dropdown a{padding:10px 15px;display:block;text-decoration:none;color:#374151;transition:background-color .1s}.profile-dropdown a:hover{background-color:#f3f4f6}h1{color:#1f2937;margin-bottom:20px;font-size:1.75rem;font-weight:700}.card{background:#fff;padding:24px;border-radius:12px;box-shadow:0 4px 6px -1px #0000001a,0 2px 4px -2px #0000001a;margin-bottom:20px;transition:transform .2s,box-shadow .2s}.dashboard-card:hover{transform:translateY(-3px);box-shadow:0 10px 15px -3px #0000001a,0 4px 6px -4px #0000001a}.form-group{margin-bottom:18px}.form-group label{display:block;margin-bottom:6px;font-weight:500;color:#374151}.form-group input,.form-group select,.form-group textarea{width:100%;padding:12px;border:1px solid #d1d5db;border-radius:8px;box-sizing:border-box;transition:border-color .2s;font-size:1em}.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#06b6d4;box-shadow:0 0 0 3px rgba(6,182,212,.3)}.btn{padding:10px 18px;border:none;border-radius:8px;cursor:pointer;font-size:1em;font-weight:600;transition:background-color .2s,transform .1s}.btn:active{transform:scale(.98)}.btn-primary{background-color:#06b6d4;color:#fff}.btn-primary:hover{background-color:#0891b2}.btn-danger{background-color:#ef4444;color:#fff}.btn-danger:hover{background-color:#dc2626}.btn-secondary{background-color:#f3f4f6;color:#374151}.btn-secondary:hover{background-color:#e5e7eb}.btn-warning{background-color:#fef3c7;color:#92400e}.btn-warning:hover{background-color:#fde68a}.dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px}.chart-placeholder{height:100px;background-color:#f3f4f6;border-radius:6px;border:1px solid #e5e7eb;display:flex;align-items:center;justify-content:center;color:#6b7280;font-size:.9em}.metric-value{font-size:2.25rem;font-weight:700;color:#1f2937}.metric-title{font-weight:500;color:#6b7280;margin-bottom:5px}.data-table{width:100%;border-collapse:separate;border-spacing:0;border-radius:8px;overflow:hidden}.data-table th,.data-table td{padding:12px 15px;text-align:left;border-bottom:1px solid #e5e7eb}.data-table th{background-color:#f3f4f6;color:#374151;font-weight:600}.data-table tbody tr:hover{background-color:#f9fafb}.badge{padding:4px 8px;border-radius:9999px;font-size:.75rem;font-weight:600;display:inline-block}.badge-created{background-color:#fde68a;color:#92400e}.badge-released{background-color:#bae6fd;color:#075985}.badge-confirmed{background-color:#a7f3d0;color:#065f46}.badge-qc{background-color:#fbcfe8;color:#9d174d}.badge-accepted{background-color:#d1fae5;color:#065f46}.badge-rejected{background-color:#fee2e2;color:#991b1b}#notification{position:fixed;top:20px;right:20px;background-color:#10b981;color:#fff;padding:12px 20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.15);opacity:0;transition:opacity .3s,transform .3s;transform:translateY(-20px);z-index:50}#notification.show{opacity:1;transform:translateY(0)}.qc-defect-row{display:flex;gap:10px;margin-bottom:10px;align-items:center}.qc-defect-row>*{flex:1}.qc-defect-row .defect-qty{flex:.5}.qc-defect-row .defect-btn-col{flex:.2;text-align:right}

    /* --- RESPONSIVE ADJUSTMENTS (Tablet/Mobile) --- */
    
    @media (max-width: 1024px) {
        /* Tablet Layout (Sidebar becomes fixed and full-height) */
        .sidebar {
            position: fixed;
            height: 100vh;
            z-index: 50;
        }

        /* Adjust main content area to clear the fixed sidebar */
        .content-area {
            margin-left: var(--sidebar-width, 250px);
            transition: margin-left .3s;
            width: auto;
        }

        /* Header bar adjusts its width and position */
        .header-bar {
            position: fixed;
            width: calc(100% - var(--sidebar-width));
            left: var(--sidebar-width, 250px);
            transition: left .3s, width .3s;
        }
        
        .sidebar.collapsed ~ .content-area {
            margin-left: 60px;
        }

        .sidebar.collapsed ~ .content-area .header-bar {
            width: calc(100% - 60px);
            left: 60px;
        }

        .main-content {
            padding: 15px;
        }
    }

    @media (max-width: 768px) {
        /* Mobile Layout (Sidebar becomes a hidden overlay) */
        .sidebar {
            width: 250px; /* Max width for mobile menu */
            transform: translateX(-250px);
            transition: transform .3s ease-in-out;
            box-shadow: none; /* Hide shadow when off-screen */
            /* Override collapsed width for mobile */
            --sidebar-width: 250px; 
        }
        
        /* Class to show the mobile sidebar overlay */
        .sidebar.mobile-open {
            transform: translateX(0);
            box-shadow: 4px 0 15px rgba(0,0,0,.4);
        }
        
        /* Content and Header always take full width */
        .content-area {
            margin-left: 0;
            width: 100%;
            padding-top: 60px; /* Reduced padding for smaller header */
        }

        /* Header takes full width and toggle button is moved inside */
        .header-bar {
            width: 100%;
            left: 0;
            justify-content: space-between;
            padding-left: 10px;
            height: 60px; /* Slightly smaller header */
        }
        
        /* Move toggle button inside the header on mobile */
        .toggle-btn {
            position: static; 
            margin-right: 15px;
            border-radius: 8px;
            box-shadow: none;
            order: -1; /* Place it on the left */
            top: auto; 
            left: auto;
        }

        /* Ensure collapsed state still hides the sidebar on mobile */
        .sidebar.collapsed {
             transform: translateX(-250px);
        }
        
        /* --- TABLE RESPONSIVENESS CARD LAYOUT --- */
        /* Force table elements to display as block, allowing them to stack */
        .data-table, .data-table tbody, .data-table tr, .data-table td, .data-table th {
            display: block;
        }

        .data-table {
            min-width: initial; /* Remove min-width to prevent horizontal scrolling */
            width: 100%;
        }
        
        .data-table thead {
            display: none; /* Hide header row on small screens */
        }

        .data-table tr {
            margin-bottom: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            background-color: #fff;
            padding: 0; /* Resetting padding */
        }
        
        /* Style individual data cells (TDs) */
        .data-table td {
            border-bottom: 1px solid #f3f4f6;
            text-align: right !important;
            padding: 10px 10px 10px 50% !important; /* Right padding + room for the label */
            position: relative;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        /* Use pseudo-element to display the column header name (label) */
        .data-table td::before {
            content: attr(data-label);
            position: absolute;
            left: 10px;
            width: 45%;
            padding-right: 10px;
            white-space: nowrap;
            text-align: left;
            font-weight: 600;
            color: #374151;
        }
        
        /* Action buttons area (must be stacked) */
        .data-table .table-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 15px !important;
            align-items: center; 
            text-align: center !important;
            border-bottom: none;
            background-color: #f9fafb;
            border-radius: 0 0 8px 8px; /* Rounded corners at the bottom of the card */
        }
        
        /* Ensure buttons take full width of the actions column */
        .data-table .table-actions button {
            width: 100%; 
            margin: 0 !important;
        }
        
        /* HIDE BUTTON LABELS ON SMALL SCREENS (NEW) */
        .data-table .table-actions .btn-label {
            display: none; 
        }
        /* --- END TABLE RESPONSIVENESS CARD LAYOUT --- */
    }

</style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <div class="flex flex-col items-center mb-6">
                <img src="https://neterwala.com/img/logo2-1.png" alt="Neterwala Logo" class="w-24 h-auto mb-2">
                <h2 class="text-3xl font-bold text-gray-800">LogMate</h2>
            </div>
            
            <form id="login-form">
                <div class="form-group">
                    <label for="username" class="text-sm font-medium text-gray-700">Username</label>
                    <input type="text" id="username" class="login-input" placeholder="aman@neterwala.com" value="aman@neterwala.com" required>
                </div>
                <div class="form-group">
                    <label for="password" class="text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" class="login-input" placeholder="pass@123" value="pass@123" required>
                </div>
                <button type="submit" class="btn login-button mt-4">Login</button>
            </form>
            
            <p class="text-center text-xs text-gray-400 mt-6">Powered by DronaHQ</p>
        </div>
    </div>

    <div id="app-container" class="container hidden-app">
        <div class="sidebar" id="sidebar">
            <div class="logo-section">
                <img src="https://neterwala.com/img/logo2-1.png" alt="Neterwala Logo" class="neterwala-logo-img">
                <span class="logo-text">LogMate</span>
            </div>

            <div class="menu-wrapper">
                <a href="#" class="menu-item active" data-module="dashboard">
                    <span class="menu-icon"><i class="fas fa-chart-line"></i></span>
                    <span class="menu-item-text">Dashboard</span>
                </a>
                <a href="#" class="menu-item" data-module="configurations">
                    <span class="menu-icon"><i class="fas fa-cog"></i></span>
                    <span class="menu-item-text">Configurations</span>
                </a>

                <div class="parent-menu-item" data-parent="assembly">
                    <span class="menu-icon"><i class="fas fa-box-open"></i></span>
                    <span class="menu-item-text flex justify-between items-center w-full">
                        <span>Assembly Process</span>
                        <i class="fas fa-angle-right transition-transform"></i>
                    </span>
                </div>
                <div class="submenu-container" data-parent-id="assembly">
                    <a href="#" class="menu-item submenu-item" data-module="assembly-release">
                        <span class="menu-icon"><i class="fas fa-list-ul"></i></span>
                        <span class="menu-item-text">Order Release</span>
                    </a>
                    <a href="#" class="menu-item submenu-item" data-module="assembly-confirm">
                        <span class="menu-icon"><i class="fas fa-check-double"></i></span>
                        <span class="menu-item-text">Order Confirmation</span>
                    </a>
                    <a href="#" class="menu-item submenu-item" data-module="assembly-qc">
                        <span class="menu-icon"><i class="fas fa-shield-alt"></i></span>
                        <span class="menu-item-text">Quality Control</span>
                    </a>
                </div>

                <div class="parent-menu-item" data-parent="pattern">
                    <span class="menu-icon"><i class="fas fa-tools"></i></span>
                    <span class="menu-item-text flex justify-between items-center w-full">
                        <span>Pattern Process</span>
                        <i class="fas fa-angle-right transition-transform"></i>
                    </span>
                </div>
                <div class="submenu-container" data-parent-id="pattern">
                    <a href="#" class="menu-item submenu-item" data-module="pattern-release">
                        <span class="menu-icon"><i class="fas fa-list-ul"></i></span>
                        <span class="menu-item-text">Order Release</span>
                    </a>
                    <a href="#" class="menu-item submenu-item" data-module="pattern-confirm">
                        <span class="menu-icon"><i class="fas fa-check-double"></i></span>
                        <span class="menu-item-text">Order Confirmation</span>
                    </a>
                    <a href="#" class="menu-item submenu-item" data-module="pattern-qc">
                        <span class="menu-icon"><i class="fas fa-shield-alt"></i></span>
                        <span class="menu-item-text">Quality Control</span>
                    </a>
                </div>
            </div>
            
            <div class="sidebar-footer">
                Powered by DronaHQ
            </div>
        </div>

        <div class="content-area" id="content-area">
            <div class="header-bar" id="header-bar">
                <button id="toggleSidebar" class="toggle-btn"><i class="fas fa-angle-left"></i></button>
                <div class="relative">
                    <div class="user-dropdown-toggle" id="userDropdownToggle">
                        <div class="user-avatar" id="userAvatar">AV</div>
                        <span class="user-name" id="userNameDisplay">Aman Verma</span>
                        <i class="fas fa-angle-down ml-2 text-gray-500 transition-transform" id="userDropdownIcon"></i>
                    </div>
                    
                    <div class="profile-dropdown hidden" id="profileDropdown">
                        <a href="#" data-action="profile"><i class="fas fa-user-circle mr-2"></i> My Profile</a>
                        <a href="#" data-action="logout" id="logoutButton"><i class="fas fa-sign-out-alt mr-2"></i> Log Out</a>
                    </div>
                </div>
            </div>
            
            <div class="main-content" id="app-content">
            </div>
        </div>
    </div>

    <div id="notification"></div>

    <div id="updateQtyModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-md">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Update Order Quantity</h3>
            <form id="updateQtyForm" onsubmit="handleUpdateQtySubmission(event)">
                <input type="hidden" id="modalOrderId">
                <div class="form-group">
                    <label for="modalMaterialCode">Material Code</label>
                    <input type="text" id="modalMaterialCode" class="bg-gray-100" readonly>
                </div>
                <div class="form-group">
                    <label for="modalCurrentQty">Current Target QTY</label>
                    <input type="number" id="modalCurrentQty" class="bg-gray-100" readonly>
                </div>
                <div class="form-group">
                    <label for="modalNewQty">New Target QTY</label>
                    <input type="number" id="modalNewQty" required min="1">
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" class="btn btn-secondary" onclick="closeUpdateQtyModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        const MOCK_USER_DATA = {'aman@neterwala.com':{name:'Aman Verma',role:'Admin',initials:'AV'},'op@neterwala.com':{name:'Deven Shah',role:'Operator',initials:'DS'},'sup@neterwala.com':{name:'Supervisor QC',role:'Supervisor',initials:'SQ'}};
        const INITIAL_ORDERS = [{id:'1001',material:'SFG049B009AS',batch:'2023-01',targetQty:1000,updatedQty:1000,status:'Created',process:'assembly'},{id:'1002',material:'SFG049B009PT',batch:'2023-02',targetQty:800,updatedQty:800,status:'Created',process:'pattern'},{id:'1003',material:'SFG049B010AS',batch:'2023-03',targetQty:1200,updatedQty:1200,status:'Released',process:'assembly'},{id:'1004',material:'SFG049B010PT',batch:'2023-04',targetQty:950,updatedQty:950,status:'Confirmed',process:'pattern'},{id:'1005',material:'SFG049B011AS',batch:'2023-05',targetQty:600,updatedQty:600,status:'Created',process:'assembly'}];
        const DEFECT_OPTIONS = ['Crack','Seal Defect','Leaf Mould','Dimensional Error','Surface Finish'];
        let globalState = {user:null,isAuthenticated:false,orders:[...INITIAL_ORDERS]};

        function showNotification(message, isError = false) {
            const n = document.getElementById('notification');
            n.textContent = message;
            n.className = isError ? 'show bg-red-500' : 'show bg-[#10b981]';
            setTimeout(() => {n.className = '';}, 3000);
        }

        function getOrderBadge(status) {
            const statusMap = {'Created':'badge-created','Released':'badge-released','Confirmed':'badge-confirmed','QC Pending':'badge-qc','Completed':'badge-accepted'};
            const textMap = {'Created':'Created','Released':'Released','Confirmed':'Confirmed','QC Pending':'QC Pending','Completed':'Completed'};
            return `<span class='badge ${statusMap[status] || 'badge-secondary'}'>${textMap[status] || status}</span>`;
        }
        function getTodayDate() { return new Date().toISOString().split('T')[0]; }

        const dashboardContent = (role) => `
            <h1>Dashboard üìä - ${role} View</h1>
            <p class="text-gray-600 mb-6">${role === 'Operator' ? 'Your immediate action items for the current shift.' : 'Real-time overview of all key operational metrics.'}</p>
            <div class="dashboard-grid">
                ${role !== 'Operator' ? `
                    <div class="card dashboard-card cursor-pointer" onclick="loadModule('assembly-confirm')"><div class="metric-title flex justify-between items-center">Production Yield (Assembly) <i class="fas fa-box-open text-cyan-600"></i></div><div class="metric-value">98.5%</div><div class="chart-placeholder">Trend: Consistent</div><p class="text-sm text-gray-500 mt-2">CTA: Confirms production data.</p></div>
                    <div class="card dashboard-card cursor-pointer" onclick="loadModule('assembly-qc')"><div class="metric-title flex justify-between items-center">QC Status (Open Lots) <i class="fas fa-shield-alt text-indigo-600"></i></div><div class="metric-value">42</div><div class="chart-placeholder">Breakdown: Pending / In Progress</div><p class="text-sm text-gray-500 mt-2">CTA: Review orders awaiting quality inspection.</p></div>
                    <div class="card dashboard-card cursor-pointer" onclick="loadModule('pattern-confirm')"><div class="metric-title flex justify-between items-center">Open Orders (Pattern) <i class="fas fa-tools text-cyan-600"></i></div><div class="metric-value">12</div><div class="chart-placeholder">Released vs. Created Count</div><p class="text-sm text-gray-500 mt-2">CTA: Confirms pattern production data.</p></div>
                    <div class="card dashboard-card cursor-pointer" onclick="loadModule('pattern-qc')"><div class="metric-title flex justify-between items-center">Defect Trend (Pattern) <i class="fas fa-exclamation-triangle text-red-600"></i></div><div class="metric-value text-red-600">3.2%</div><div class="chart-placeholder">Top 3 Defects (Crack, Seal, Leaf Mould)</div><p class="text-sm text-gray-500 mt-2">CTA: Review recent quality issues.</p></div>
                    <div class="card dashboard-card cursor-pointer" onclick="loadModule('production-status')"><div class="metric-title flex justify-between items-center">Inspection Compliance (MIS) <i class="fas fa-award text-yellow-600"></i></div><div class="metric-value">99.1%</div><div class="chart-placeholder">Trend: Target vs Actual</div><p class="text-sm text-gray-500 mt-2">CTA: Check Production Status setup.</p></div>
                    <div class="card dashboard-card"><div class="metric-title flex justify-between items-center">Avg. Order Lead Time (STATS) <i class="fas fa-clock text-gray-600"></i></div><div class="metric-value">1.5 Days</div><div class="chart-placeholder">Comparison to Target (2.0 Days)</div><p class="text-sm text-gray-500 mt-2">Metric: From Creation to Confirmation.</p></div>
                    <div class="card dashboard-card cursor-pointer" onclick="loadModule('assembly-confirm')"><div class="metric-title flex justify-between items-center">Total Order Volume (MIS) <i class="fas fa-truck-loading text-cyan-600"></i></div><div class="metric-value">5,800 Pcs</div><div class="chart-placeholder">Monthly Volume</div><p class="text-sm text-gray-500 mt-2">CTA: Confirms production data.</p></div>
                    <div class="card dashboard-card cursor-pointer" onclick="loadModule('pattern-qc')"><div class="metric-title flex justify-between items-center">Batch Traceability (STATS) <i class="fas fa-search text-gray-600"></i></div><div class="metric-value">100%</div><div class="chart-placeholder">System Compliance Check</div><p class="text-sm text-gray-500 mt-2">CTA: Review QC records.</p></div>
                ` : `
                    <div class="card dashboard-card cursor-pointer bg-blue-50 border-l-4 border-blue-500" onclick="loadModule('assembly-release')"><div class="metric-title flex justify-between items-center">Orders to Release (Assembly) <i class="fas fa-list-ul text-blue-500"></i></div><div class="metric-value text-blue-700">${globalState.orders.filter(o => o.process === 'assembly' && o.status === 'Created').length}</div><div class="chart-placeholder border-blue-100">Action: Update QTY & Release</div><p class="text-sm text-gray-500 mt-2">CTA: Go to Assembly Release List.</p></div>
                    <div class="card dashboard-card cursor-pointer bg-green-50 border-l-4 border-green-500" onclick="loadModule('assembly-confirm')"><div class="metric-title flex justify-between items-center">Orders to Confirm (Assembly) <i class="fas fa-clipboard-check text-green-500"></i></div><div class="metric-value text-green-700">${globalState.orders.filter(o => o.process === 'assembly' && o.status === 'Released').length}</div><div class="chart-placeholder border-green-100">Action: Enter Yield Data</div><p class="text-sm text-gray-500 mt-2">CTA: Go to Assembly Confirmation Form.</p></div>
                    <div class="card dashboard-card cursor-pointer bg-blue-50 border-l-4 border-blue-500" onclick="loadModule('pattern-release')"><div class="metric-title flex justify-between items-center">Orders to Release (Pattern) <i class="fas fa-list-ul text-blue-500"></i></div><div class="metric-value text-blue-700">${globalState.orders.filter(o => o.process === 'pattern' && o.status === 'Created').length}</div><div class="chart-placeholder border-blue-100">Action: Update QTY & Release</div><p class="text-sm text-gray-500 mt-2">CTA: Go to Pattern Release List.</p></div>
                    <div class="card dashboard-card cursor-pointer bg-green-50 border-l-4 border-green-500" onclick="loadModule('pattern-confirm')"><div class="metric-title flex justify-between items-center">Orders to Confirm (Pattern) <i class="fas fa-clipboard-check text-green-500"></i></div><div class="metric-value text-green-700">${globalState.orders.filter(o => o.process === 'pattern' && o.status === 'Released').length}</div><div class="chart-placeholder border-green-100">Action: Enter Yield Data</div><p class="text-sm text-gray-500 mt-2">CTA: Go to Pattern Confirmation Form.</p></div>
                    <div class="card dashboard-card"><div class="metric-title flex justify-between items-center">Avg. Time to Release (Shift) <i class="fas fa-history text-yellow-600"></i></div><div class="metric-value">15 min</div><div class="chart-placeholder">Shift Target: 10 min</div><p class="text-sm text-gray-500 mt-2">Metric: Speed of order setup.</p></div>
                    <div class="card dashboard-card"><div class="metric-title flex justify-between items-center">Current Shift Output <i class="fas fa-chart-bar text-cyan-600"></i></div><div class="metric-value">2,500 Pcs</div><div class="chart-placeholder">Goal: 4,000 Pcs</div><p class="text-sm text-gray-500 mt-2">Metric: Total pieces confirmed this shift.</p></div>
                `}
            </div>
        `;

        const configurationsContent = `
            <h1>Configurations ‚öôÔ∏è</h1>
            <p class="text-gray-600 mb-6">System-wide settings that affect order visibility and status.</p>
            <div class="card">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">System Control</h2>
                <p class="text-sm text-gray-500 mb-4">Select the global order visibility status. This controls whether **Close/Techo** orders are excluded from Order Release and Confirmation views.</p>
                <div class="form-group">
                    <label>Order Visibility</label>
                    <div class="flex gap-6 items-center mt-1">
                        <label class="inline-flex items-center text-gray-700">
                            <input type="radio" name="order-visibility" value="all" checked class="form-radio text-cyan-500 focus:ring-cyan-500"> 
                            <span class="ml-2">All Orders (Including Close/Techo)</span>
                        </label>
                        <label class="inline-flex items-center text-gray-700">
                            <input type="radio" name="order-visibility" value="exclude-closed" class="form-radio text-cyan-500 focus:ring-cyan-500"> 
                            <span class="ml-2">Exclude Close/Techo Orders</span>
                        </label>
                    </div>
                </div>
                <hr class="my-6 border-gray-200">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">API Synchronization (Mock)</h2>
                <p class="text-sm text-gray-500">Triggers for fetching new order data and pushing confirmed data to SAP.</p>
                <button class="btn btn-secondary"><i class="fas fa-sync-alt mr-2"></i> Sync Orders from SAP</button>
                <button class="btn btn-secondary ml-4"><i class="fas fa-upload mr-2"></i> Push Completed QC Data</button>
            </div>
        `;

        const orderReleaseContent = (process, processName) => {
            const processOrders = globalState.orders.filter(o => o.process === process && (o.status === 'Created' || o.status === 'Released'));
            return `
                <h1>${processName} Order Release</h1>
                <p class="text-gray-600 mb-6">Manage order creation, quantity updates, and final release for production.</p>
                <div class="card bg-gray-50 mb-6">
                    <h2 class="text-lg font-semibold mb-3 text-gray-700">Filters</h2>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="form-group mb-0"><label for='${process}-date-start' class="text-xs">Date Range Start</label><input type="date" id='${process}-date-start' class="text-sm" value="2023-01-01"></div>
                        <div class="form-group mb-0"><label for='${process}-date-end' class="text-xs">Date Range End</label><input type="date" id='${process}-date-end' class="text-sm" value="${getTodayDate()}"></div>
                        <div class="form-group mb-0"><label for='${process}-status-filter' class="text-xs">Status</label><select id='${process}-status-filter' class="text-sm"><option value="all">All</option><option value="Created">Created</option><option value="Released">Released</option></select></div>
                        <div class="form-group mb-0"><label for='${process}-order-id' class="text-xs">Order ID</label><input type="text" id='${process}-order-id' class="text-sm" placeholder="Search ID"></div>
                    </div>
                </div>
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Order Release Control</h2>
                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead><tr><th>Order ID</th><th>Material Code</th><th>Batch</th><th>Target QTY</th><th>Updated QTY</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody id='${process}-order-table-body'>
                                ${processOrders.map(order => `
                                    <tr data-id="${order.id}" data-status="${order.status}">
                                        <td data-label="Order ID">${order.id}</td>
                                        <td data-label="Material Code">${order.material}</td>
                                        <td data-label="Batch">${order.batch}</td>
                                        <td data-label="Target QTY">${order.targetQty}</td>
                                        <td data-label="Updated QTY" class="qty-display">${order.updatedQty}</td>
                                        <td data-label="Status">${getOrderBadge(order.status)}</td>
                                        <td data-label="Actions" class="table-actions">
                                            <button title="Update Qty" class="btn btn-warning update-qty-btn ${order.status !== 'Created' ? 'opacity-50 cursor-not-allowed' : ''}" data-id="${order.id}" ${order.status !== 'Created' ? 'disabled' : ''} onclick="handleUpdateQty(event)"><i class="fas fa-edit"></i> <span class="btn-label">Update Qty</span></button>
                                            <button title="Release Order" class="btn btn-primary release-btn ${order.status !== 'Created' ? 'opacity-50 cursor-not-allowed' : ''}" data-id="${order.id}" ${order.status !== 'Created' ? 'disabled' : ''} onclick="handleReleaseOrder(event)"><i class="fas fa-share-square"></i> <span class="btn-label">Release Order</span></button>
                                            <button title="Confirm Order" class="btn btn-secondary confirm-btn ${order.status === 'Released' ? '' : 'opacity-50 cursor-not-allowed'}" data-id="${order.id}" ${order.status !== 'Released' ? 'disabled' : ''} onclick="loadModule('${process}-confirm', { orderId: '${order.id}' })"><i class="fas fa-clipboard-check"></i> <span class="btn-label">Confirm Order</span></button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        };

        const orderConfirmationContent = (process, processName, initialOrderId) => {
            const releasedOrders = globalState.orders.filter(o => o.process === process && o.status === 'Released');
            const defaultOrderId = initialOrderId || (releasedOrders.length > 0 ? releasedOrders[0].id : '');
            
            return `
                <h1>${processName} Order Confirmation</h1>
                <p class="text-gray-600 mb-6">Final step for production: entering yield and confirming the order.</p>
                <div class="card max-w-2xl mx-auto">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Production Output Details</h2>
                    <form onsubmit="handleOrderConfirmation(event, '${process}')">
                        <div class="form-group">
                            <label for="confirm-orderId">Select Released Order</label>
                            <select id="confirm-orderId" required>
                                ${releasedOrders.length > 0 ? releasedOrders.map(order => `<option value="${order.id}" ${order.id === defaultOrderId ? 'selected' : ''}>Order ${order.id} - ${order.material} (QTY: ${order.updatedQty})</option>`).join('') : '<option value="">No Released Orders Available</option>'}
                            </select>
                        </div>
                        <div class="form-group"><label for="confirm-yield">Enter the Yield (Produced QTY)</label><input type="number" id="confirm-yield" required placeholder="Total Quantity Produced" value="${defaultOrderId ? globalState.orders.find(o => o.id === defaultOrderId)?.updatedQty : ''}"></div>
                        <div class="form-group"><label for="confirm-postDate">POSTING DATE</label><input type="date" id="confirm-postDate" required value="${getTodayDate()}"></div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="form-group"><label for="confirm-acceptedQty">Accepted QTY</label><input type="number" id="confirm-acceptedQty" required placeholder="Quantity passing inspection" value="1000"></div>
                            <div class="form-group"><label for="confirm-rejectedQty">Rejected QTY</label><input type="number" id="confirm-rejectedQty" required placeholder="Quantity rejected" value="0"></div>
                        </div>
                        <div class="mt-6"><button type="submit" class="btn btn-primary">Confirm Order</button></div>
                    </form>
                </div>
            `;
        };

        const qcContentTemplate = (process, processName) => {
            const confirmedOrders = globalState.orders.filter(o => o.process === process && o.status === 'Confirmed');
            return `
                <h1>${processName} Quality Control (Supervisor)</h1>
                <p class="text-gray-600 mb-6">Perform inspection for confirmed orders and determine usage decision.</p>
                <div class="card max-w-4xl mx-auto">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Order Inspection Details (QC is performed for one order at a time)</h2>
                    <form onsubmit="handleQCSubmission(event, '${process}')">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                            <div class="form-group mb-0"><label for="qc-orderId">Select Order ID</label><select id="qc-orderId" required onchange="updateQCMaterial(this.value)">
                                ${confirmedOrders.length > 0 ? confirmedOrders.map(order => `<option value='${order.id}'>Order ${order.id} - ${order.material} (QTY: ${order.updatedQty})</option>`).join('') : '<option value="">No Confirmed Orders Available</option>'}
                            </select></div>
                            <div class="form-group mb-0"><label for="qc-materialCode">Material Code</label><input type="text" id="qc-materialCode" class="bg-gray-100" readonly value="${confirmedOrders.length > 0 ? confirmedOrders[0].material : 'N/A'}"></div>
                        </div>
                        <div class="form-group"><label for="qc-inspectedQty">Inspected QTY (Total)</label><input type="number" id="qc-inspectedQty" required placeholder="Total Quantity Inspected" value="${confirmedOrders.length > 0 ? confirmedOrders[0].updatedQty : ''}"></div>
                        <hr class="my-6 border-gray-200">
                        <h3 class="text-lg font-semibold mb-3 text-gray-800">Quantity Result & Defects</h3>
                        <div class="form-group"><label class="mb-2">Binary Output</label><div class="flex gap-6">
                            <label class="inline-flex items-center text-gray-700"><input type="radio" name="qc-result" value="OK" checked class="form-radio text-green-500 focus:ring-green-500"> <span class="ml-2">OK</span></label>
                            <label class="inline-flex items-center text-gray-700"><input type="radio" name="qc-result" value="Not OK" class="form-radio text-red-500 focus:ring-red-500"> <span class="ml-2">Not OK</span></label>
                        </div></div>
                        <div class="mb-4 p-4 border border-gray-200 rounded-lg">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="font-medium text-gray-700">Defects Log (Not OK QTY)</h4>
                                <button type="button" class="btn btn-secondary" onclick="addDefectRow('${process}')"><i class="fas fa-plus"></i> Add Defect</button>
                            </div>
                            <div id="${process}-defects-container"></div>
                        </div>
                        <hr class="my-6 border-gray-200">
                        <div class="form-group"><label for="qc-usageDecision">Usage Decision</label><select id="qc-usageDecision" required>
                            <option value="">Select Usage Decision...</option><option value="Accept">Accept</option><option value="Partially Accept">Partially Accept</option><option value="Reject">Reject</option><option value="Inspection Details">Inspection Details</option>
                        </select></div>
                        <div class="mt-6"><button type="submit" class="btn btn-primary bg-indigo-600 hover:bg-indigo-700">Complete QC</button></div>
                    </form>
                </div>
            `;
        };

        const moduleContents = {
            'dashboard': (params) => dashboardContent(globalState.user.role),
            'production-status': () => configurationsContent,
            'assembly-release': () => orderReleaseContent('assembly', 'Assembly'),
            'assembly-confirm': (params) => orderConfirmationContent('assembly', 'Assembly', params.orderId),
            'assembly-qc': () => qcContentTemplate('assembly', 'Assembly'),
            'pattern-release': () => orderReleaseContent('pattern', 'Pattern'),
            'pattern-confirm': (params) => orderConfirmationContent('pattern', 'Pattern', params.orderId),
            'pattern-qc': () => qcContentTemplate('pattern', 'Pattern'),
        };

        const moduleAccess = {
            'Admin': ['dashboard', 'production-status', 'assembly-release', 'assembly-confirm', 'assembly-qc', 'pattern-release', 'pattern-confirm', 'pattern-qc'],
            'Operator': ['dashboard', 'assembly-release', 'assembly-confirm', 'pattern-release', 'pattern-confirm'],
            'Supervisor': ['dashboard', 'production-status', 'assembly-qc', 'pattern-qc'],
        };

        function showNotification(message, isError = false) {
            const n = document.getElementById('notification');
            n.textContent = message;
            n.className = isError ? 'show bg-red-500' : 'show bg-[#10b981]';
            setTimeout(() => {n.className = '';}, 3000);
        }
        function getTodayDate() { return new Date().toISOString().split('T')[0]; }

        function openUpdateQtyModal(orderId, currentQty, materialCode) {
            document.getElementById('modalOrderId').value = orderId;
            document.getElementById('modalMaterialCode').value = materialCode;
            document.getElementById('modalCurrentQty').value = currentQty;
            document.getElementById('modalNewQty').value = currentQty;
            document.getElementById('updateQtyModal').classList.remove('hidden');
        }

        function closeUpdateQtyModal() {
            document.getElementById('updateQtyModal').classList.add('hidden');
            document.getElementById('updateQtyForm').reset();
        }

        function handleUpdateQtySubmission(event) {
            event.preventDefault();
            const orderId = document.getElementById('modalOrderId').value;
            const newQty = parseInt(document.getElementById('modalNewQty').value);
            
            if (newQty && !isNaN(newQty)) {
                const index = globalState.orders.findIndex(o => o.id === orderId);
                if (index !== -1) {
                    globalState.orders[index].updatedQty = newQty;
                    const process = globalState.orders[index].process;
                    closeUpdateQtyModal();
                    loadModule(process + '-release');
                    showNotification(`Order ${orderId} QTY updated to ${newQty}.`);
                }
            } else {
                showNotification('Invalid quantity entered.', true);
            }
        }

        function setupMenu(role) {
            const allItems = document.querySelectorAll('.menu-item, .parent-menu-item');
            allItems.forEach(item => item.style.display = 'none');
            const allowedModules = moduleAccess[role] || [];
            
            allItems.forEach(item => {
                const moduleName = item.getAttribute('data-module');
                if (moduleName && allowedModules.includes(moduleName)) {
                    item.style.display = 'flex';
                }
                
                if (moduleName && item.classList.contains('submenu-item') && allowedModules.includes(moduleName)) {
                    item.style.display = 'flex';
                    const parentId = item.closest('.submenu-container').getAttribute('data-parent-id');
                    const parentToggle = document.querySelector(`[data-parent="${parentId}"]`);
                    if (parentToggle) parentToggle.style.display = 'flex';
                }
            });
        }

        function loadModule(moduleName, params = {}) {
            if (!globalState.isAuthenticated) return;
            
            if (!moduleAccess[globalState.user.role].includes(moduleName) && globalState.user.role !== 'Admin') {
                document.getElementById('app-content').innerHTML = `<div class="card p-8 text-center bg-red-50 border-red-200"><h1 class="text-red-600">Access Denied</h1><p class="text-gray-600">Your role (${globalState.user.role}) does not have permission to view the **${moduleName}** module.</p><button class="btn btn-primary mt-4" onclick="loadModule('dashboard')">Go to Dashboard</button></div>`;
                return;
            }
            
            const contentFn = moduleContents[moduleName];
            if (!contentFn) {
                document.getElementById('app-content').innerHTML = `<h1>Module Not Found: ${moduleName}</h1>`;
                return;
            }

            document.getElementById('app-content').innerHTML = contentFn(params);
            document.querySelectorAll('.menu-item, .parent-menu-item').forEach(item => {
                item.classList.remove('active');
                item.closest('.submenu-container')?.classList.remove('open');
                item.querySelector('.fa-angle-right')?.classList.remove('rotate-90');
            });

            const activeItem = document.querySelector(`.menu-item[data-module="${moduleName}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
                const submenuContainer = activeItem.closest('.submenu-container');
                if (submenuContainer) {
                    submenuContainer.classList.add('open');
                    const parentId = submenuContainer.getAttribute('data-parent-id');
                    const parentToggle = document.querySelector(`.parent-menu-item[data-parent="${parentId}"]`);
                    if (parentToggle) {
                        parentToggle.classList.add('active');
                        parentToggle.querySelector('.fa-angle-right')?.classList.add('rotate-90');
                    }
                }
            }
            
            if (moduleName.endsWith('-qc')) {
                const process = moduleName.split('-')[0];
                const container = document.getElementById(`${process}-defects-container`);
                if (container && container.children.length === 0) {
                    addDefectRow(process);
                }
            }

            // Close mobile menu after loading module
            if (isMobileView() && document.getElementById('sidebar').classList.contains('mobile-open')) {
                 document.getElementById('sidebar').classList.remove('mobile-open');
                 document.getElementById('toggleSidebar').innerHTML = '<i class="fas fa-bars"></i>';
            }
        }

        function handleUpdateQty(event) {
            const button = event.currentTarget;
            const row = button.closest('tr');
            const orderId = button.getAttribute('data-id');
            const currentQty = parseInt(row.querySelector('.qty-display').textContent);
            const materialCode = row.cells[1].textContent;
            openUpdateQtyModal(orderId, currentQty, materialCode);
        }

        function handleReleaseOrder(event) {
            const orderId = event.currentTarget.getAttribute('data-id');
            const orderIndex = globalState.orders.findIndex(o => o.id === orderId);

            if (orderIndex !== -1) {
                globalState.orders[orderIndex].status = 'Released';
                loadModule(globalState.orders[orderIndex].process + '-release');
                showNotification(`Order ${orderId} Released! Ready for Confirmation.`);
            }
        }

        function handleOrderConfirmation(event, process) {
            event.preventDefault();
            const yieldQty = parseInt(document.getElementById('confirm-yield').value);
            const acceptedQty = parseInt(document.getElementById('confirm-acceptedQty').value);
            const rejectedQty = parseInt(document.getElementById('confirm-rejectedQty').value);
            
            if (yieldQty !== acceptedQty + rejectedQty) {
                showNotification('Total Yield must equal Accepted QTY + Rejected QTY.', true);
                return;
            }
            const orderIndex = globalState.orders.findIndex(o => o.id === document.getElementById('confirm-orderId').value);
            if (orderIndex !== -1) {
                globalState.orders[orderIndex].status = 'Confirmed';
                document.getElementById(event.target.id).reset();
                showNotification(`Order ${globalState.orders[orderIndex].id} Confirmed! Now PENDING QC.`);
                loadModule(process + '-release');
            }
        }

        function updateQCMaterial(orderId) {
            const order = globalState.orders.find(o => o.id === orderId);
            if (order) {
                document.getElementById('qc-materialCode').value = order.material;
                document.getElementById('qc-inspectedQty').value = order.updatedQty;
            } else {
                document.getElementById('qc-materialCode').value = 'N/A';
                document.getElementById('qc-inspectedQty').value = '';
            }
        }

        function addDefectRow(process) {
            const container = document.getElementById(`${process}-defects-container`);
            const newRow = document.createElement('div');
            newRow.className = 'qc-defect-row';
            newRow.innerHTML = `<select class='w-full'>
                <option value=''>Select Defect Type</option>${DEFECT_OPTIONS.map(d => `<option value='${d}'>${d}</option>`).join('')}</select>
                <input type='number' placeholder='Defect QTY' class='defect-qty'>
                <div class='defect-btn-col'><button type='button' class='btn btn-danger' onclick='removeDefectRow(this)'><i class='fas fa-trash'></i></button></div>`;
            container.appendChild(newRow);
        }

        function removeDefectRow(button) { button.closest('.qc-defect-row').remove(); }

        function handleQCSubmission(event, process) {
            event.preventDefault();
            const orderId = document.getElementById('qc-orderId').value;
            const decision = document.getElementById('qc-usageDecision').value;
            if (!orderId || !decision) {showNotification(`Please select an Order ID and Usage Decision.`, true); return;}
            const orderIndex = globalState.orders.findIndex(o => o.id === orderId);
            if (orderIndex !== -1) {
                globalState.orders.splice(orderIndex, 1);
                showNotification(`QC Completed for Order ${orderId}. Decision: ${decision}.`, false);
                loadModule(process + '-qc');
            }
        }

        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();

            if (username in MOCK_USER_DATA && password === 'pass@123') {
                const userData = MOCK_USER_DATA[username];
                globalState.isAuthenticated = true;
                globalState.user = userData;
                document.getElementById('userNameDisplay').textContent = userData.name;
                document.getElementById('userAvatar').textContent = userData.initials;
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').classList.remove('hidden-app');
                
                // Set initial toggle icon based on screen size
                const toggleBtn = document.getElementById('toggleSidebar');
                if (isMobileView()) {
                    toggleBtn.innerHTML = '<i class="fas fa-bars"></i>';
                } else {
                    toggleBtn.innerHTML = '<i class="fas fa-angle-left"></i>';
                }

                setupMenu(userData.role);
                loadModule('dashboard');
            } else {
                document.getElementById('login-form').reset();
                showNotification('Invalid credentials. Please try again.', true);
            }
        }

        function handleLogout() {
            globalState.isAuthenticated = false;
            globalState.user = null;
            document.getElementById('app-container').classList.add('hidden-app');
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('profileDropdown').classList.add('hidden');
            showNotification('Logged out successfully.');
        }

        // Helper function for responsiveness check
        function isMobileView() {
            return window.matchMedia('(max-width: 768px)').matches;
        }


        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('toggleSidebar');

            toggleBtn.addEventListener('click', () => {
                if (isMobileView()) {
                    // On mobile (<= 768px), sidebar acts as an overlay menu
                    sidebar.classList.toggle('mobile-open');
                    toggleBtn.innerHTML = sidebar.classList.contains('mobile-open') ? '<i class="fas fa-times"></i>' : '<i class="fas fa-bars"></i>';
                } else {
                    // On tablet/desktop, toggle the 'collapsed' class (pushes content)
                    sidebar.classList.toggle('collapsed');
                    toggleBtn.innerHTML = sidebar.classList.contains('collapsed') ? '<i class="fas fa-angle-right"></i>' : '<i class="fas fa-angle-left"></i>';
                }
            });
            
            const userDropdownToggle = document.getElementById('userDropdownToggle');
            const profileDropdown = document.getElementById('profileDropdown');

            userDropdownToggle?.addEventListener('click', (e) => {
                profileDropdown.classList.toggle('hidden');
                e.stopPropagation();
            });
            
            document.addEventListener('click', (e) => {
                if (profileDropdown && userDropdownToggle && !userDropdownToggle.contains(e.target) && !profileDropdown.contains(e.target)) {
                    profileDropdown.classList.add('hidden');
                }
            });

            document.getElementById('logoutButton')?.addEventListener('click', (e) => {
                e.preventDefault();
                handleLogout();
            });

            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    loadModule(item.getAttribute('data-module'));
                });
            });

            document.querySelectorAll('.parent-menu-item').forEach(parentItem => {
                parentItem.addEventListener('click', () => {
                    const parentId = parentItem.getAttribute('data-parent');
                    const submenu = document.querySelector(`[data-parent-id="${parentId}"]`);
                    const icon = parentItem.querySelector('.fa-angle-right');

                    if (submenu.classList.contains('open')) {
                        submenu.classList.remove('open');
                        icon.classList.remove('rotate-90');
                    } else {
                        document.querySelectorAll('.submenu-container.open').forEach(s => s.classList.remove('open'));
                        document.querySelectorAll('.parent-menu-item .fa-angle-right.rotate-90').forEach(i => i.classList.remove('rotate-90'));
                        submenu.classList.add('open');
                        icon.classList.add('rotate-90');
                    }
                });
            });
        });
    </script>
</body>
</html>
